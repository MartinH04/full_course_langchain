# 代理的使用


在 LangChain 框架中，Agent 模块实现了多种类型的 Agent，比如 ZeroShotAgent，OpenAIFunctionsAgent。另外框架鼓励开发者创建自己的 Agent。理解这些 Agent 的使用步骤，以及如何自定义 Agent 都至关重要。

首先，我们需要明白创建和运行 Agent 是两个分离的步骤。创建 Agent 是通过实例化 Agent 类（如 ZeroShotAgent，或者是你创建的）来完成的。在创建 Agent 的过程中，Tools 也会被用于提示模板。

创建好 Agent 后，我们需要将其放入 AgentExecutor 中进行运行。AgentExecutor 是 Agent 的运行环境，它是一个链组件。我们实际上运行的是这个链组件，而不是 Agent 本身。在运行过程中，AgentExecutor 会调用 Tools 的方法来执行具体的任务。

以下是一个使用 ZeroShotAgent 的示例：

```python
from langchain.agents import ZeroShotAgent, Tool, AgentExecutor

llm_chain = LLMChain(llm=OpenAI(temperature=0), prompt=prompt)

tool_names = [tool.name for tool in tools]
agent = ZeroShotAgent(llm_chain=llm_chain, allowed_tools=tool_names)

agent_executor = AgentExecutor.from_agent_and_tools(
    agent=agent, tools=tools, verbose=True
)

agent_executor.run("How many people live in canada as of 2023?")
```

在这个示例中，我们首先创建了一个 ZeroShotAgent 实例，并将其放入了 AgentExecutor 中。然后，我们调用了 AgentExecutor 的 run 方法来运行这个 Agent，并获取了其运行结果。

这是目前最通用的 Agent 的实现方法。无论是自定义还是内置的 Agent 都遵循这个使用步骤。对于内置的 Agent 类型，还有一个简化方法，简化的原因是把之前的二个步骤，简化为了一个步骤，不需要创建 Agent 实例，也不需要创建 agent_executor：


agent = initialize_agent(
    tools, llm, agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose=True
)

initialize_agent 方法被广泛用于 Langchain 生态的项目中。比如我们刚刚使用的 agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION， 实际上它对应的是 ZeroShotAgent，值得注意的是如果并不在这个清单内，这个方法并不适用。以下类型均可以使用这个方法：

AGENT_TO_CLASS: Dict[AgentType, Type[BaseSingleActionAgent]] = {
    AgentType.ZERO_SHOT_REACT_DESCRIPTION: ZeroShotAgent,
    AgentType.REACT_DOCSTORE: ReActDocstoreAgent,
    AgentType.SELF_ASK_WITH_SEARCH: SelfAskWithSearchAgent,
    AgentType.CONVERSATIONAL_REACT_DESCRIPTION: ConversationalAgent,
    AgentType.CHAT_ZERO_SHOT_REACT_DESCRIPTION: ChatAgent,
    AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION: ConversationalChatAgent,
    AgentType.STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION: StructuredChatAgent,
    AgentType.OPENAI_FUNCTIONS: OpenAIFunctionsAgent,
}

下面我们通过一个实际的应用案例代码，展示一个完整的使用步骤。

## 设置 Agent

我们先安装要用到的库。

```
pip -q install langchain huggingface_hub openai google-search-results tiktoken wikipedia
```

设置密钥。

```
import os
os.environ["OPENAI_API_KEY"] = ""
os.environ["SERPAPI_API_KEY"] = ""
```

设置 Agent 的过程包含了两个主要步骤：加载 Agent 将使用的工具，然后用这些工具初始化 Agent。在代码示例中，我们首先初始化了一些基础设置，然后加载了两个工具：一个使用搜索 API 进行搜索的工具，以及一个可以进行数学运算的计算器工具。

加载工具和初始化 Agent。
```
from langchain.agents import load_tools
from langchain.agents import initialize_agent
from langchain.llms import OpenAI

llm = OpenAI(temperature=0)
```

每个工具都有一个名称和描述，告诉我们它是用来做什么的。在我们的示例中，“serpapi”工具用于搜索，而“llm-math”工具则用于解决数学问题。这些工具内部有很多内容，包括模板和许多不同的 chains。

```
tools = load_tools(["serpapi", "llm-math"], llm=llm)
```

## 初始化 Agent

一旦我们设置好了工具，我们就可以开始初始化 Agent。初始化 Agent 需要我们传入工具和语言模型，以及 Agent 的类型或风格。在我们的示例中，我们使用了零镜像反应性 Agent，这是基于一篇关于让语言模型采取行动并生成操作步骤的论文。

```
agent = initialize_agent(tools, 
                         llm, 
                         agent="zero-shot-react-description", 
                         verbose=True)
```     


## Agent 的提示

初始化 Agent 的重要步骤之一是设置执行器的提示。这些提示会在 Agent 开始运行时提示语言模型，告诉它应该做什么。

```
agent.agent.llm_chain.prompt.template
```

在我们的示例中，我们为 Agent 设置了两个工具：搜索引擎和计算器。然后，我们设置了 Agent 应该返回的格式，这包括它需要回答的问题，以及它应该采取的行动和行动的输入。

```
'Answer the following questions as best you can. You have access to the following tools:\n\nSearch: A search engine. Useful for when you need to answer questions about current events. Input should be a search query.\nCalculator: Useful for when you need to answer questions about math.\n\nUse the following format:\n\nQuestion: the input question you must answer\nThought: you should always think about what to do\nAction: the action to take, should be one of [Search, Calculator]\nAction Input: the input to the action\nObservation: the result of the action\n... (this Thought/Action/Action Input/Observation can repeat N times)\nThought: I now know the final answer\nFinal Answer: the final answer to the original input question\n\nBegin!\n\nQuestion: {input}\nThought:{agent_scratchpad}'
```

## Agent 的运行

最后，我们运行 Agent。需要注意的是，Agent 并不总是需要使用工具。在我们的示例中，我们问 Agent "你今天好吗？"。对于这样的问题，Agent 并不需要进行搜索或计算，而是可以直接生成回答。

```
agent.run("Hi How are you today?")
```

这就是 Langchain Agents 的基本概念和使用方法。


## 使用 Math 模块


我们在前半部分介绍了 Agent 的基础知识和功能。现在，我们要继续探讨如何在实际中应用 Agent，以及在某些情况下，Agent 可能遇到的问题。


```
agent.run("Where is DeepMind's office?")
```

在我们的示例中，我们尚未使用到 math 模块，让我们来看一下它的作用。我们让 Agent 查找 Deep Mind 的街道地址的数字，然后进行平方。

```
agent.run("If I square the number for the street address of DeepMind what answer do I get?")
```

Agent 首先进行搜索获取地址，然后找到了数字 5（假设为地址的一部分），最后进行平方运算，得出结果 25。然而，如果问题中包含多个数字，Agent 可能会对哪个数字进行平方产生混淆，这就是一些可能需要考虑和解决的问题。

```
> Entering new AgentExecutor chain...
 I need to find the street address of DeepMind first.
Action: Search
Action Input: "DeepMind street address"
Observation: DeepMind Technologies Limited, is a company organised under the laws of England and Wales, with registered office at 5 New Street Square, London, EC4A 3TW (“DeepMind”, “us”, “we”, or “our”). DeepMind is a wholly owned subsidiary of Alphabet Inc. and operates https://deepmind.com (the “Site”).
Thought: I now need to calculate the square of the street address.
Action: Calculator
Action Input: 5^2
Observation: Answer: 25
Thought: I now know the final answer.
Final Answer: 25

> Finished chain.
'25'
```

## 使用终端工具

在我们的工具库中，还有一个我们还未使用过的工具，那就是终端工具。例如，我们可以问 Agent 当前目录中有哪些文件。

```
agent.run("What files are in my current directory?")
```

Agent 将运行一个 LS 命令来查看文件夹，并返回一个文件列表。

```

> Entering new AgentExecutor chain...
 I need to find out what files are in my current directory.
Action: Terminal
Action Input: ls
Observation: sample_data

Thought: I need to find out more information about this file.
Action: Terminal
Action Input: ls -l sample_data
Observation: total 55504
-rwxr-xr-x 1 root root     1697 Jan  1  2000 anscombe.json
-rw-r--r-- 1 root root   301141 Mar 10 20:51 california_housing_test.csv
-rw-r--r-- 1 root root  1706430 Mar 10 20:51 california_housing_train.csv
-rw-r--r-- 1 root root 18289443 Mar 10 20:51 mnist_test.csv
-rw-r--r-- 1 root root 36523880 Mar 10 20:51 mnist_train_small.csv
-rwxr-xr-x 1 root root      930 Jan  1  2000 README.md

Thought: I now know the final answer.
Final Answer: The files in my current directory are anscombe.json, california_housing_test.csv, california_housing_train.csv, mnist_test.csv, mnist_train_small.csv, and README.md.

> Finished chain.
'The files in my current directory are anscombe.json, california_housing_test.csv, california_housing_train.csv, mnist_test.csv, mnist_train_small.csv, and README.md.'
```



我们甚至可以问它特定的文件是否存在，比如询问当前目录中是否有一个关于加利福尼亚的文件。

```
agent.run("Does my current directory have a file about California?")
```

Agent 会使用 grep 命令进行检索，并向我们报告结果。然而，这个过程可能需要多次调用语言模型，从而产生一定的运行成本。

```
> Entering new AgentExecutor chain...
 I need to find out what files are in my current directory.
Action: Terminal
Action Input: ls
Observation: sample_data

Thought: I need to find out if there is a file about California in this directory.
Action: Terminal
Action Input: grep California sample_data
Observation: Command 'grep California sample_data' returned non-zero exit status 2.
Thought: I need to look for a different way to search for the file.
Action: Search
Action Input: "California file in current directory"
Observation: The pwd command displays the full, absolute path of the current, or working, directory. It's not something you'll use all the time, but it can ...
Thought: I need to use the pwd command to find the file.
Action: Terminal
Action Input: pwd
Observation: /content

Thought: I need to use the ls command to find the file.
Action: Terminal
Action Input: ls
Observation: sample_data

Thought: I need to use the grep command to find the file.
Action: Terminal
Action Input: grep California sample_data
Observation: Command 'grep California sample_data' returned non-zero exit status 2.
Thought: I need to look for a different way to search for the file.
Action: Search
Action Input: "California file in current directory"
Observation: The pwd command displays the full, absolute path of the current, or working, directory. It's not something you'll use all the time, but it can ...
Thought: I need to use the find command to find the file.
Action: Terminal
Action Input: find . -name "*California*"
Observation: Command 'find . -name "*California*' returned non-zero exit status 2.
Thought: I need to use the grep command to find the file.
Action: Terminal
Action Input: grep -R California *
Observation: sample_data/README.md:*   `california_housing_data*.csv` is California housing data from the 1990 US

Thought: I now know the final answer.
Final Answer: Yes, there is a file about California in the current directory.

> Finished chain.
'Yes, there is a file about California in the current directory.'
```

## 注意事项

使用终端工具时，需要非常谨慎。你不希望最终用户能够通过运行终端命令来操作你的文件系统，因此在添加这个工具时，需要确保适当的安全防护措施已经到位。不过，尽管有其潜在风险，但在某些情况下，使用终端工具还是很有帮助的，比如当你需要设置某些功能时。


以上就是 Langchain agents 的一些主要特点和应用示例。